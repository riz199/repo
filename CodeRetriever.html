<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retriever</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: auto;
    padding: 20px;
    background-color: #f8f9fa;
    color: #212529;
  }
  h2 {
    color: #343a40;
    text-align: center;
    margin-bottom: 20px;
    font-weight: 600;
  }
  label {
    font-weight: 500;
    margin-top: 10px;
  }
  input[type="text"], input[type="password"], input[list], input[type="file"] {
    height: 38px;
    font-size: 1rem;
  }
  #results {
    margin-top: 20px;
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
  }
  .result-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 8px;
    font-family: monospace;
    font-size: 0.95rem;
    align-items: center;
  }
  .result-row > .code {
    flex: 1 1 100px;
    font-weight: bold;
    user-select: text;
  }
  .link-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }
  .link-row > input[type="text"] {
    flex: 7 1 200px;
  }
  .link-row > input[list] {
    flex: 3 1 100px;
  }
  #aesPasswordContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }
  #aesPasswordContainer > input[type="password"] {
    flex: 1 1 200px;
  }
  #retrieveAllBtn {
    flex: 0 0 auto;
  }

  /* Input + buttons group */
  .input-with-buttons {
    display: flex;
    flex: 2 1 150px;
    max-width: 400px;
  }
  .input-with-buttons input {
    flex: 1;
    min-width: 0;
  }
  .input-with-buttons button {
    flex: 0 0 auto;
    height: 38px;
  }
</style>
</head>
<body>
<h2>Retriever</h2>

<label>Upload File (.txt):</label>
<input class="form-control" type="file" id="fileInput" accept=".txt"><br>

<label>Paste Link &nbsp; <span style="font-weight: normal; font-size: 0.85rem;">(or select link)</span></label>
<div class="link-row">
  <input class="form-control" type="text" id="linkInput" placeholder="Enter link here..." />
  <input class="form-control" list="encryptedLinks" id="encryptedLinkSelector" placeholder="Select or type" autocomplete="off" />
  <datalist id="encryptedLinks">
    <option value="john"></option>
    <option value="paul"></option>
  </datalist>
</div>

<label>AES Decryption Password:</label>
<div id="aesPasswordContainer">
  <input class="form-control" type="password" id="aesPassword" placeholder="Enter AES password" />
  <button class="btn btn-primary" id="retrieveAllBtn" onclick="retrieveAll()">Retrieve All</button>
</div>

<div id="results"></div>

<script>
let encryptedContent = '';
const HARDCODED_FALLBACK_LINK = "link";
const ENCRYPTED_LINKS = {
  anon: "U2FsdGVkX1/e1MQlF8ECQGTO7yTWEPhUgJy9frLZ4nF0DpYqjyggP8SR5fH8mWB9633XbVG6QV9dpNcbSjR68OAcW4xvu/S0345E1I8nL/zN7X49/+A4gkuAVGHK9pw3H8O9MNfV0De1GT7spsTjl69FqXo1M7V0J0fVL7KlLFt9+11beAje02UU09NDrz/Va2lfEPCR2ku5pBnLfDN04w==",
  paul: "U2FsdGVkX19oN2I7FJ6X/o8pbcMspFUyCzjVvEGV9BLjRiNzRXlo=="
};
const PASSWORD_PREFIX = "!@#$%^&*()_+ꙮ₪؋₩฿₺৳⸘⍰⌘⏚⧫🂡🝰🜚";
const PASSWORD_SUFFIX = "+_)(*&^%$ꙮ₪؋₩฿₺৳⸘⍰⌘⏚⧫🂡🝰🜚";

document.getElementById('fileInput').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    encryptedContent = e.target.result;
    alert("File loaded successfully.");
  };
  reader.readAsText(file);
});

function getRawDropboxLink(url) {
  try {
    const d = new URL(url);
    if (d.hostname.includes("dropbox.com")) {
      const pathParts = d.pathname.split('/');
      const fileId = pathParts.slice(3).join('/');
      return `https://dl.dropboxusercontent.com/s/${fileId}?dl=1`;
    }
  } catch (e) {}
  return url;
}

async function loadRemoteContent(url) {
  try {
    const res = await fetch(getRawDropboxLink(url));
    if (!res.ok) throw new Error("Network error or CORS blocked.");
    return await res.text();
  } catch (err) {
    alert("Failed to load remote file: " + err.message);
    return null;
  }
}

async function retrieveAll() {
  const rawPass = document.getElementById('aesPassword').value.trim();
  if (!rawPass) { alert("Please enter AES password."); return; }
  const aesPass = PASSWORD_PREFIX + rawPass + PASSWORD_SUFFIX;
  const userLink = document.getElementById('linkInput').value.trim();
  const selectedEncryptedKey = document.getElementById('encryptedLinkSelector').value.trim();
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  let content = encryptedContent;

  if (!content) {
    let fetchLink = "";
    if (userLink) fetchLink = userLink;
    else if (selectedEncryptedKey && ENCRYPTED_LINKS[selectedEncryptedKey]) {
      try {
        const decryptedLinkBytes = CryptoJS.AES.decrypt(ENCRYPTED_LINKS[selectedEncryptedKey], aesPass);
        fetchLink = decryptedLinkBytes.toString(CryptoJS.enc.Utf8);
        if (!fetchLink) throw new Error("Invalid password for encrypted link.");
      } catch (err) {
        alert("Failed to decrypt selected link: " + err.message);
        return;
      }
    } else fetchLink = HARDCODED_FALLBACK_LINK;

    content = await loadRemoteContent(fetchLink);
    if (!content) return;
  }

  try {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    let decryptedText = "";
    for (const line of lines) {
      const bytes = CryptoJS.AES.decrypt(line, aesPass);
      const dec = bytes.toString(CryptoJS.enc.Utf8);
      if (!dec) throw new Error("Decryption failed on one or more lines.");
      decryptedText += dec + "\n";
    }

    const entryRegex = /<ENTRY\s+code="([^"]+)">([\s\S]*?)<\/ENTRY>/gi;
    let match;
    let foundAny = false;

    while ((match = entryRegex.exec(decryptedText)) !== null) {
      foundAny = true;
      const code = match[1].trim();
      const password = match[2].trim();

      const row = document.createElement('div');
      row.className = 'result-row';

      const codeDiv = document.createElement('div');
      codeDiv.className = 'code';
      codeDiv.textContent = code;

      // input + buttons flex container
      const inputGroup = document.createElement('div');
      inputGroup.className = 'input-with-buttons';

      const passInput = document.createElement('input');
      passInput.type = 'password';
      passInput.readOnly = true;
      passInput.value = password;

      const eyeBtn = document.createElement('button');
      eyeBtn.type = 'button';
      eyeBtn.className = 'btn btn-outline-secondary';
      eyeBtn.textContent = '👁️';
      eyeBtn.title = "Toggle visibility";
      eyeBtn.addEventListener('click', () => {
        passInput.type = passInput.type === 'password' ? 'text' : 'password';
      });

      const copyBtn = document.createElement('button');
      copyBtn.type = 'button';
      copyBtn.className = 'btn btn-outline-secondary';
      copyBtn.textContent = '📋 Copy';
      copyBtn.title = "Copy password silently";
      copyBtn.addEventListener('click', () => {
        if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(password).catch(() => fallbackCopy(passInput));
        else fallbackCopy(passInput);
      });

      function fallbackCopy(inputElem) {
        inputElem.select();
        document.execCommand('copy');
      }

      // Append eye then copy
      inputGroup.appendChild(passInput);
      const buttonGroup = document.createElement('div');
      buttonGroup.style.display = 'flex';
      buttonGroup.style.gap = '4px';
      buttonGroup.appendChild(eyeBtn);
      buttonGroup.appendChild(copyBtn);
      inputGroup.appendChild(buttonGroup);

      row.appendChild(codeDiv);
      row.appendChild(inputGroup);
      resultsDiv.appendChild(row);
    }

    if (!foundAny) resultsDiv.textContent = "No entries found.";
  } catch (e) {
    alert("Decryption failed. Check AES password or file format.");
  }
}
</script>
</body>
</html>

